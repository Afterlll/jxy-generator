# 存储优化

## 一、存储优化思路

存储是一个很广泛的概念，有很多种存储技术，比如数据库存储、内存存储、对象存储、块存储、文件存储等。

可以从多个不同的角度进行存储优化，比如
* 存储空间优化
* 存储成本优化
* 存储安全性优化
* 存储可用性优化
* 存储可靠性优化
* 存储性能优化

下面是一些通用的存储优化手段。

### 通用存储优化手段

#### 存储空间优化

主要的目标是减少存储空间的占用，常用的方法有：
1. 压缩: 使用**压缩算法**对数据进行压缩，减小存储空间的占用。常见的压缩算法有 **gzip**.
**zstd** 等。
2. 分区分表: 常用于数据库和大数据存储，将大量数据分别存放于不同的分区和表中，从而提高单表查询性能，并减小单表数据量。
3. 数据清理(归档): 定期清理过期或不再需要的数据。或者将不常用的数据归档到其他存储中。就像我们管理自己的电脑一样，多余的文件可以拷贝到单独的硬盘里。
4. 数据去重: 去除重复的数据或者复用数据，常用于网盘系统的实现(比如**秒传**功能)。

#### 存储成本优化

顾名思义，减少存储消耗的成本。

存储空间优化一般情况下也会带来存储成本的优化，但是二者的概念不完全相同。

存储成本优化除了空间方面的考虑外，还要考虑存储管理和维护成本、设备成本、使用成本等，目标是在**提供足够性能和可用性的前提**下，降低整个存储系统的总体成本。常用的优化方法有:

1. 选择合适的存储技术: 专业的存储服务特定的业务，比如用图数据库存储关联数据、向量数据库存储向量数据，往往“事半功倍”。
2. 合理采购存储资源: 从需求和业务出发，评估存储用量，避免过度购买存储资源。
此外，不同存储的成本优化方式不尽相同，像我们本项目所使用的**腾讯云 COS 对象存储**，官方提供了一些成本优化的建议。

> [腾讯云官网存储成本优化最佳实践](https://cloud.tencent.com/document/product/436/50201)

#### 存储安全性优化

存储安全性优化的目标是保护存储数据的完整、安全，防止数据泄露等。

常用方法有:

1. 数据加密: 使用合适的加密算法确保数据在存储过程、存储对象上的安全性。
2. 备份恢复: 定期备份数据，以便在数据丢失或损坏时能够迅速恢复。
3. 访问控制: 设置合适的权限和访问控制策略，确保只有授权用户能够访问存储的数据。
4. 日志审计: 记录关键操作的日志，便于出现问题后的故障定位。还可以通过定期查阅日志，提前发现一些潜在的问题。
此外，不同存储的安全性优化方式不尽相同。

#### 其他优化

前文提到的几种优化方式是对于开发者来说相对可干预的，此外，还有一些其他的存储优化角度，比如:

1. 存储可用性优化: 保证存储系统在任何时候都能正常提供服务，常用方法有容错、冗余备份、故障转移、快速故障检测恢复等。
2. 存储可靠性优化: 保证数据的完整性和系统地稳定性。可以通过在底层选用高可靠的硬件设备来实现。
3. 存储性能优化: 提高存储系统的读写速度、降低响应延迟等。
4. 存储管理优化: 提高操作存储、配置和监控存储资源的有效性，可以通过自动化管理工具实现。
5. 存储可观测性优化: 更好地检测存储系统的运行状态、资源占用和行为。可以通过可视化监控看板、完备的日志和告警系统实现。

在此项目中，以使用 COS 对象存储为前提，我们进行了以下三方面的存储优化。
* 存储空间优化
* 存储成本优化
* 存储安全性优化

## 二、存储空间优化

### 分析
结合我们的项目来分析存储空间优化的方法:

1) 文件压缩: 可以将多个模板文件压缩打包后上传，这点之前我们已经实现了。

还可以对单个文件进行压缩，比如用户头像、代码生成器封面等。这也是 [COS 官方强烈推荐的方式](https://cloud.tencent.com/document/product/436/50201#.E4.BC.98.E5.8C.96.E4.B8.89.EF.BC.9A.E9.80.9A.E8.BF.87.E6.96.87.E4.BB.B6.E5.8E.8B.E7.BC.A9.E5.87.8F.E5.B0.91.E5.AD.98.E5.82.A8.E5.AE.B9.E9.87.8F)。

官方自带了图像自动压缩处理的功能(数据万象)，点几下配置即可。如下图：

![img_19.png](img%2Fimg_19.png)

2) 文件瘦身: 除了压缩文件减少文件体积外，还可以精简文件本身的体积。比如制作工具项目中，我们额外生成了一个 dist 目录作为产物包，移除了不必要的源码文件。
3) 数据去重: 可以通过文件的 MD5 值判断是否已存在相同的文件，如果重复就不再上传而是将新文件的路径指向已有文件。类似秒传的实现原理，但是实现成本比较高，仅做了解即可。
4) 文件清理: **定期清理项目中不需要的文件**。这是业务开发中最常用的一种方式，下面我们重点来实现。

### 文件清理机制设计

首先明确需求：**每天** 清理所有无用的文件，**包括** 用户上传的模板制作文件(generator make template)、已删除的代码生成器对应的产物包文件(generator dist)。

然后再进行方案设计，关键要考虑 2 个问题：
1. 如何触发任务的定时执行?
2. 如何高效删除文件?

对于第一个问题，这里我们使用的实现方式为 —— **分布式任务调度系统**。

对于第二个问题，如何高效删除文件呢?

一个个删除的性能往往是很低的，要多次请求对象存储，所以选用批量删除的方式。

* 对于用户上传的模板制作文件，可以整体删除模板制作文件目录。
* 对于代码生成器对应的产物包文件，先找到要清理的文件列表，然后进行批量删除。

### 分布式任务调度系统
#### 什么是分布式任务调度系统？
分布式任务调度系统是专用于协调和执行分布式场景中任务的系统。相当于一家公司的老大给员工分配任务、通知员工执行任务，保证大家不会做重复的工作，并提高任务执行的效率和可靠性。

主流的分布式任务调度系统有 **XXL-JOB**、**ElasticJob** 等。这里我们使用相对更简单易用的 **XXL-JOB**。

#### XXL-JOB 介绍

XXL-JOB 是一个非常成熟的开源定时任务调度系统，有几万个 star，它的优点是易学易用、
易部署、易扩展，经过多家知名公司生产环境的验证。

> [官方文档](https://www.xuxueli.com/xxl-job/)

> [GitHub 开源](https://github.com/xuxueli/xxl-job)

> [Gitee 开源](https://gitee.com/xuxueli0323/xxl-job)

测试发现，如果有已经触发但是没有执行完成的任务(比如线程阻塞了)，哪怕这时关闭任务，也会把积压的请求完成。如果这时候 XXL-JOB 管理系统挂了，这时客户端不再执行定时任务，但客户端会不断重连 XXL-JOB 管理系统，等管理系统重新上线后，仍然会继续运行积压的请求。这是 XXL-JOB 为我们提供的能力之一，相比于自己开发一套任务调度系统，使用XXL-JOB 更省时省心。

XXL-JOB 的整体架构：
![img_20.png](img%2Fimg_20.png)

从整体到局部，XXL-JOB 分为调度中心和执行器。调度中心相当于管理者，管理分配任务执行器相当于员工，执行任务。

员工首先要在公司完成注册(注册线程调用注册服务)，然后调度中心就可以通过调度器来调用执行器，执行器负责完成任务并且向调度中心汇报进度和情况(日志)，调度中心可以管理任务的执行情况并提供可视化监控面板。

以下为主要的逻辑实现：
```java
/**
 * 定期清除无用的 COS 资源
 */

@Component
@Slf4j
public class ClearCosJobHandler {

    @Resource
    private CosManager cosManager;

    @Resource
    private GeneratorMapper generatorMapper;

    /**
     * 每天执行
     * @throws Exception
     */
    @XxlJob("clearCosJobHandler")
    public void clearCosJobHandler() throws Exception {
        log.info("clearCosJobHandler start");

        // 编写业务逻辑

        // 1. 清除 模板制作文件（generator_make_template）
        cosManager.deleteDir("/generator_make_template/");
        // 2. 清除已删除的代码生成器对于的产物包文件（generator_dist）
        List<Generator> generatorList = generatorMapper.listDeletedGenerator();
        List<String> keyList = generatorList.stream().map(Generator::getDistPath)
                .filter(StrUtil::isNotBlank)
                // 移除 ‘/’ 前缀，删除目录时特别需要注意的！
                .map(distPath -> distPath.substring(1))
                .collect(Collectors.toList());
        cosManager.deleteObjects(keyList);

        log.info("clearCosJobHandler end");
    }

}
```

注意：一定要先启动 XXL-JOB 的后台。

之后前往 [控制台](http://localhost:8080/xxl-job-admin) 配置任务即可。

![img_21.png](img%2Fimg_21.png)

## 三、存储成本优化
> [官方文档](https://cloud.tencent.com/document/product/436/50201)

**存储容量费用** 和 **流量费用** 是其云存储成本的主要组成部分。成本优化也可以从这些角度进行。

### 选择合适的存储

要根据实际的需求和业务选择对象存储的类型和业务地域。

腾讯云 COS 提供了标准存储、低频存储、归档存储、深度归档存储，后三种存储类型的存储容量费用较低。

官方提供的费用参考表:

![img_22.png](img%2Fimg_22.png)

我们会发现，**存储总费用最低的存储类型未必最合适**。如果业务数据下载量较低，则选择归档存储甚至深度归档存储能有效降低存储成本，最冷的深度归档存储相较标准存储可节省 90%存储费用;但如果业务数据需要频繁下载，则低频存储、归档存储、深度归档存储的取回费用会带来额外的成本开销，导致整体费用反而更高。

具体到业务场景中，官方推荐:
1. 频繁读写场景: 例如 UGC 场景、电商图片等读多写少的业务，可使用标准存储类型。如果业务对可用性和数据持久性有高要求，则可以考虑使用标准存储(多 AZ)。
2. 少量读场景(一个月读一次): 例如日志数据分析、网盘数据等业务，读取频率较低，但读取时对性能要求高，可使用低频存储类型。对可用性和数据持久性有高要求的业务可以使用低频存储(多 AZ)。
3. 极少量读场景(三个月读一次): 例如视频监控、日志数据归档等业务，读取频率极低，对读取性能要求较低，可使用归档存储类型。
4. 基本不读取场景(半年读一次): 例如医疗影像、档案资料等业务，日常仅做长期备份用途，对读取性能几乎无要求，可使用深度归档存储类型。

### 数据沉降

对于大部分数据而言，其访问热度一般随着存储时间延长而降低。因此，如果想严格控制成本，需要根据业务数据访问情况的变化，分析调整数据存储类型。

一般情况下，数据沉降分为 2个阶段:先分析再沉降。

1) 先分析: 通过对象存储提供的清单/访问日志分析，或者业务代码中自行统计分析。
2) 再沉降: 可以直接通过对象存储提供的 **生命周期** 功能自动沉降数据，如下图:

![img_23.png](img%2Fimg_23.png)
![img_24.png](img%2Fimg_24.png)
![img_25.png](img%2Fimg_25.png)


对于我们的项目，可以将很久不访问的代码生成器沉降到存储成本更低的低频存储中。除了利用生命周期功能外，也可以通过数据库记录代码生成器的使用和下载时间，自行调用 API 批量沉降数据或者转储到其他服务。



### 减少访问

减少访问的目的是降低流量费，比如使用本地文件缓存，减少访问对象存储的文件。

CDN 本质上也是一种缓存，虽然能减少对象存储的访问(回源)，但是会有额外的 CDN 流量费用。

## 四、存储安全性优化

存储安全是至关重要的，目前我们的对象存储访问权限为“公有读”，处于“半裸奔状态", 下面我们通过多种方式优化。

> [官方文档](https://cloud.tencent.com/document/product/436/50200)


### 事前防护手段

1. 权限隔离

2. 对象锁定

3. 数据灾备

### 事中监控手段

### 事后追溯手段

### 安全管理
COS 对象管理提供了如下的一些安全管理措施：
![img_26.png](img%2Fimg_26.png)

#### 1. 跨域访问CORS设置

跨域访问即通过 HTTP 请求，从一个域去请求另一个域的资源。只要协议、域名、端口有任何一个不相同，都会被当作是不同的域。

注意，跨域是浏览器的限制，一般用于前端直传对象存储的场景。

> [设置跨域访问的官方文档](https://cloud.tencent.com/document/product/436/13318)

进入控制台操作即可。


#### 2. 防盗链设置 
> [官方文档](https://cloud.tencent.com/document/product/436/13319)


盗链是指在网站或应用程序中，直接引用并展示其他网站上的资源(如图片、音频、视频等)，而未经该资源拥有者的许可。比如A用户有一个壁纸网站，B用户直接把 A 用户网站的所有图片爬取到自己网站中，并且用 A 网站的图片地址展示，实际消耗的还是 A 网站的流量!这是一种成本极低、危害极大的攻击方式。

如何防盗链呢?

可以通过请求头中的 referer(网站请求来源)来进行校验，如果请求头中没有该字段，或者不是预期的来源，就禁止请求。

可以在控制台中进行防盗链配置。

假设项目上线的前端域名是 jxy.com，建议配置白名单，仅允许特定范围的域名访问，并目拒绝空 referer。如图:

![img_27.png](img%2Fimg_27.png)

打开控制台，发现图片加载请求报错 403，访问被禁止，说明防盗链生效:

![img_28.png](img%2Fimg_28.png)

#### 3. 服务端加密
服务端加密又分为: 加密存储和加密传输，适用于安全性较高的使用场景。

加密存储:数据写入磁盘之前，对数据进行加密，并在访问数据时自动解密。加密和解密这-操作过程都是在服务端完成，有效保护数据。

加密传输:COS 提供用 HTTPS 部署 SSL证书实现加密的功能，在传输链路层上建立加密层，确保数据在传输过程中不会被窃取及篡改。

需要注意的是，文件加密会有一定的性能影响，所以要慎重开启。以下是官方原文:

> 文件加密需要用客户侧密钥，或者 COS 托管密钥，或者 KMS 密钥将文件内容加密成密文，因此会有一定的性能损耗，主要体现在访问延迟增加。这一延迟增加对大文件读写影响不明显，但在小文件读写中会有一定影响。

可以在服务器加密控制台开启:
![img_29.png](img%2Fimg_29.png)

#### 4. 盗刷风险监测

COS 提供了盗刷风险检测功能，非常实用，可以轻松发现潜在的安全风险。

如下图，我们的存储访问权限存在风险:

![img_30.png](img%2Fimg_30.png)

### 现存权限风险

我们对系统的预期是，仅允许登录用户下载代码生成器文件。而现在用户只要知道文件在COS 的存储地址，不用登录也可以直接访问下载。

比如访问:https://xxx.cos.ap-shanghai.myqcloud.com/generator dist/1738875515482562562/7rkzyMn3-acm-template-pro-generator.zip(示例链接)

由于防盗链限制，无法直接得到文件:

![img_31.png](img%2Fimg_31.png)

但别忘了，请求是可以构造的!比如复制请求信息为 CURL:

![img_32.png](img%2Fimg_32.png)

修改复制的脚本，追加请求头信息，并输出文件。

文件是可以下载的。

### 权限管理实践

首先明确我们的需求: 对于图片资源，允许所有用户读;对于其他文件(比如代码生成器产物包)，禁止匿名用户访问。

COS 对象存储提供了几种权限管理方法，用户的总权限为这三种管理方法的组合。

如下图:
![img_33.png](img%2Fimg_33.png)

1) 存储桶访问权限: 可以控制已有账号、子账号操作存储桶的权限。粒度较粗。
2) 自定义 policy 杈限: 可以更灵活地控制某个用户、在某个条件下、对某个资源的、某种操作权限。粒度更细。

![img_34.png](img%2Fimg_34.png)

#### 1. 创建子账户

进行管理页面：https://console.cloud.tencent.com/cam

![img_35.png](img%2Fimg_35.png)
快速创建子账户：
![img_36.png](img%2Fimg_36.png)
注意修改访问方式和用户具有的权限：
![img_37.png](img%2Fimg_37.png)
需要开启编程访问：
![img_38.png](img%2Fimg_38.png)
选择策略，直接取消所有默认权限，后面一条一条添加：
![img_39.png](img%2Fimg_39.png)

#### 2. 修改存储桶访问权限

遵循最小权限原则，先将公共权限设置为“私有读写’保证只有授权用户才能访问。

然后给新建的子用户增加访问存储桶的权限，注意保存。
![img_40.png](img%2Fimg_40.png)

#### 3. 配置 Policy 权限

下面要开放图片的公开读权限，配置 policy 权限：

![img_43.png](img%2Fimg_43.png)
![img_41.png](img%2Fimg_41.png)
![img_42.png](img%2Fimg_42.png)

