# 江喜原 - 定制化代码生成项目

> 该项目目前处于开发阶段 🐣，项目会持续开发完善，感谢大家的关注支持！

## 项目介绍

这是一个非常有趣又实用的项目，基于 React + Spring Boot + Vert.x 响应式编程的 **定制化代码生成项目** 。



注意！这次的项目会很特别，听起来是一个项目，但其实是循序渐进的 **3 个项目** ！



完整项目分为 3 个阶段：

1）第一阶段，制作属于自己的 `本地代码生成器` ，是一个 **基于命令行的脚手架** ，能够根据用户的交互式输入快速生成特定代码。





2）第二阶段，让我们上升一个层次，我们开发 `制作代码生成器的工具` 。比如你有一段常用的项目代码，使用该工具，可以快速把项目代码制作为代码生成器，将是提高工作效率的大杀器！



3）第三阶段，让我们再上升一个层次，开发 `在线代码生成器平台` ！你可以在平台上制作发布自己的代码生成器，还可以在线使用别人的代码生成器，甚至可以共享协作！


![img_1.png](img%2Fimg_1.png)


### 学习意义

1）教程资料少：网上虽然有现成的项目模板，但基本都是别人封装好的，只能按作者的要求生成，并且缺少项目教程；而本项目不仅带大家做自己的代码生成器，还会 **进 2 步** 扩展，打造制作自定义代码生成器的工具和平台。

2）新颖且亮眼：别人写代码，而你做生产代码的脚手架、工具和平台来提高研发效能，降维打击。

3）能学到东西：不再是增删改查的项目，而是包含了大量的实际业务场景、系统设计和解决方案。

4）有区分度：区别于传统 Web 应用，项目涉及命令行应用、响应式编程、性能优化的入门及实战，给你的简历增加竞争力。



### 解决的问题

1）代码生成器本身的作用就是自动生成常见、重复性的代码片段，**解决重复编码、效率低下的问题** 。

2）虽然网上有很多代码生成器，但都是别人制作封装好的，很多时候还是 **无法满足实际开发的定制化需求** （比如要在每个类上增加特定的注解和注释）。这也是为什么明明有代码生成器，很多开发者还是会抱怨自己的工作总是复制粘贴、编写重复的代码、天天 CRUD（增删改查）。如果能够有一个工具帮助开发者快速定制属于自己的代码生成器，那么将进一步提高开发效率。

3）在团队开发中，要生成的代码可能是需要频繁变化和持续更新维护的。如果有一个线上平台来维护多个不同的代码生成器，支持在线编辑和共享生成器，在提高开发效率的同时、将有利于协作共建，打造更高质量的代码生成器。



### 实际应用

举例一些代码生成的实际应用场景，我们将通过本项目进行解决：

1）经常做算法题目的同学，可能需要一套 Java ACM 代码输入模板，能够支持多种不同输入模式（比如单次读取和循环）。

2）经常开发新项目的同学，可能需要一套初始化项目模板代码，比如一键生成 Controller 层代码（替换其中的对象）、整合 Redis 和 MySQL 依赖等。

3）甚至可以制作项目 “换皮” 工具，支持一键给网络热门项目换皮（比如替换项目的名称、Logo 等）



## 技术选型

暂定的核心技术如下，实际开发中还会引入新技术



### 前端

- React 开发框架 + 组件库 + 代码编辑器
- 前端工程化：ESLint + Prettier + TypeScript



### 后端

- Java Spring Boot + MySQL + MyBatis Plus（万用后端模板）
- Java 命令行应用开发
- FreeMarker 模板引擎
- Vert.x 响应式编程
- Caffeine + Redis 多级缓存
- 分布式任务调度系统
- 多种设计模式
- 多种系统设计的巧思
- 对象存储

## 项目设计

### 第一阶段

#### java原生方式实现

基于 ACM TEMPLATE 实现java原生方式代码生成器

##### 静态代码生成器实现

此处的静态文件，是我们根据需求下的一个定义，指生成时可以直接复制、不做任何改动的文件。


- 使用现有的工具库复制目录
  
    > hutool官方文档：[https://www.hutool.cn/]()

  这种方式的优点显而易见，非常简单，但缺点就是不够灵活，只能整个目录生成，如果想忽略目录中的某个文件，就得生成后再删除，浪费性能。



- 递归遍历

  如果自己实现递归遍历，就可以很轻松地得到目录的完整结构树信息，可以由此制作出文件对比工具、目录分析工具、目录总结工具等等
    



##### 动态代码生成器实现


实现了静态文件生成(复制目录)后，接下来让我们思考下如何对某个基础文件进行定制，根据用户的输入参数动态生成文件
明确动态生成需求
- 对于 ACM 示例模板项目，我们可以怎么定制生成呢?
让我们先明确几个动态生成的需求:
  1. 在代码开头增加作者 @Author 注释(增加代码
  2. 修改程序输出的信息提示(替换代码)
  3. 将循环读取输入改为单次读取 (可选代码)


> 使用模板引擎解决 [https://freemarker.apache.org/docs/index.html]()




##### 静态 + 动态代码生成器实现

现有工具 + 模板引擎 




#### java命令行实现


##### 需要使用命令行的原因

之前我们实现的基于java的方式，对应用户来说是很不友好的，对于使用我们项目的用户来说，不仅需要下载我们的源码，还需要安装java环境，这是十分致命的。基于此原因，开发命令行版本应运而生。


##### 什么是命令行程序？
- 命令行程序俗称 CLI(Command Line Interface) ，是指通过命令行界面运行的应用程序。通过终端窗口接收用户输入的 **纯文本** 命令，并执行相应的任务
- 一些常见的命令行环境包括 Unix/Linux 的终端、Windows 的命令提示符和 PowerShel等。学编程的同学可能没有开发过命令行程序，但一定都接触过终端!




##### 命令的结构
一图胜千言，输入给命令行的命令通常包含
- command: 命令类型，具体要做的事。
- option: 选项，用于改变命令的行为。
- parameter: 参数，传递给命令行工具的值。

![img.png](img%2Fimg.png)

##### 为什么要开发命令行?
命令行程序的几个优点:
- 不依赖于特定的图形界面，非常轻量
- 通常可以直接在操作系统自带的终端环境中运行
- 可以和用户交互、给用户输入引导和帮助手册
- 内置一些快捷操作(比如查看历史命令、上下切换命令)

还有一个最大的优点 —— 简单直接，比如复制粘贴别人写好的命令就能执行，而不用像使用网页一样点击多次，非常符合程序员的使用 (偷懒)习惯，less is more!


##### 解决方案

这里我们使用 **Picocli** 实现命令行模式的开发。
- github文档   [https://github.com/remkop/picocli]()
- 官方文档      [https://picocli.info/]()
- 中文教程      [https://blog.csdn.net/it_freshman/article/details/125458116]()


##### Picocli 命今行代码生成器开发

首先明确我们的需求，这个命令行程序需要支持 3 种子命令

- **generate** 子命令
  - 生成文件
- **list** 子命令
  - 查看要生成的原始文件列表信息
- **config** 子命令
  - 查看允许用户传入的动态参数信息



##### 命名行的使用方式

- jar包构建
  - java jar [jar包] generate -a -l -o
- 脚本
  ```
  #!/bin/bash 
  java -jar target/jxy-generator-basic-1.0-SNAPSHOT-jar-with-dependencies.jar "$@"
  ```
  
#### 制作工具开发

首先，定要理清楚生成器制作工具、代码生成器和目标代码的关系，如下图：
![img_2.png](img%2Fimg_2.png)
完整业务流程图如下:
![img_3.png](img%2Fimg_3.png)

##### 元信息
* 为什么需要元信息文件呢? 本质上是把在项目中硬编码的内容转为可以灵活替换的配置。
* 这里我们使用**JSON**格式存储元信息。
* 常见的一些JSON 文件转 Java 类代码的 IDEA 插件 ：
  * GsonFormatPlus 
  * oboPOJOGenerator 
  * Json2Pojo
* 例子
```json
{
  "name": "acm-template-pro-generator",
  "description": "ACM 示例模板生成器",
  "basePackage": "com.jxy",
  "version": "1.0",
  "author": "jxy",
  "createTime": "2023-12-4",
  "fileConfig": {
    "inputRootPath": "D:/code/project/generator/jxy-generator/jxy-generator-demo/acm-template-pro",
    "outputRootPath": "generated",
    "type": "dir",
    "files":[
      {
        "inputPath": "src/com/jxy/acm/MainTemplate.java.ftl",
        "outputPath": "src/com/jxy/acm/MainTemplate.java",
        "type": "file",
        "generateType": "dynamic"
      },
      {
        "inputPath": ".gitignore",
        "outputPath": ".gitignore",
        "type": "file",
        "generateType": "static"
      },
      {
        "inputPath": "README.md",
        "outputPath": "README.md",
        "type": "file",
        "generateType": "static"
      }
    ]
  },
  "modelConfig": {
    "models": [
      {
        "fieldName": "loop",
        "type": "boolean",
        "description": "是否循环",
        "defaultValue": "false",
        "abbr": "l"
      },
      {
        "fieldName": "author",
        "type": "String",
        "description": "作者",
        "defaultValue": "jxy",
        "abbr": "a"
      },
      {
        "fieldName": "outputText",
        "type": "String",
        "description": "输出信息",
        "defaultValue": "sum = ",
        "abbr": "o"
      }
    ]
  }
}
```

##### 开发步骤
开发顺序遵循上面需求分析中提到的代码生成器制作步骤，分为
1. 项目初始化 
2. 读取元信息 
3. 生成数据模型文件 
4. 生成 Picocli 命令类 
5. 生成代码生成文件
6. 程序构建jar 包 
7. 程序封装脚本 
8. 测试验证


#### 制作工具优化

##### 可移植性优化
在之前的代码实现中，模板文件的路径是绝对路径，此时改变运行环境就会出现问题，**可移植性差**，此时将绝对路径改为相对路径就解决了该问题。
具体步骤：
1. meta.json中新增一个 **sourceRootPath** 代替原本的 inputRootPath
2. inputRootPath 替换为 .source/ + sourceRootPath的最后一级目录
3. 复制模板文件到 inputRootPath 下
##### 功能优化
1. 增加项目于介绍文件
2. 制作精简版代码生成器
3. 支持Git托管项目
##### 健壮性优化
1. 该项目的重点是代码生成，而代码又是基于**元信息**生成的，因此**元信息校验和默认值填充**对于该项目的健壮性至关重要。
2. 自定义异常类
3. 编写校验类
4. 圈复杂度优化
   * 在IDEA 中，可以通过 **MetricsReloaded** 插件来检测代码圈复杂度
##### 可扩展性优化
1. 枚举类定义
   * 文件类型枚举：dir、file
   * 文件生成类型枚举：dynamic、static
   * 模板类型枚举：字符串、布尔
2. 模板方法模式
   * 使用模板方法模式可以实现更加细致化的用户定制，如：是否生成精简版代码、是否开启Git托管。